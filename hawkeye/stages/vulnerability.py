
"""Stage 5: Vulnerability Scanning"""

from pathlib import Path
from hawkeye.tools.nuclei import Nuclei
from hawkeye.tools.enum4linux_ng import Enum4linuxNg
from hawkeye.tools.gf import Gf
from hawkeye.ui.logger import get_logger

logger = get_logger()

class VulnerabilityStage:
    """Vulnerability scanning stage"""
    
    def __init__(self, config):
        self.config = config
        self.skip_tools = config.get('skip_tools', [])
        self.only_tools = config.get('only_tools', [])
    
    def execute(self, output_dir):
        """Execute vulnerability scanning"""
        results = {}
        stage_dir = Path(output_dir) / '05-vulnerability'
        stage_dir.mkdir(parents=True, exist_ok=True)
        
        logger.info("[*] Stage 5: Vulnerability Scanning")
        logger.info(f"[*] Output: {stage_dir}")
        logger.info("")
        
        # Step 1: Nuclei vulnerability scanning
        if self._should_run_tool('nuclei'):
            logger.info("[*] Step 1/3: Nuclei Vulnerability Scanning")
            
            # Get URLs from web stage
            web_dir = Path(output_dir) / '03-web'
            urls_file = web_dir / 'httpx_output.txt'
            
            if urls_file.exists() and urls_file.stat().st_size > 0:
                nuclei = Nuclei(self.config)
                nuclei_output = stage_dir / 'nuclei_output.json'
                
                nuclei_results = nuclei.run(urls_file, nuclei_output)
                results['nuclei'] = nuclei_results
            else:
                logger.warning("[!] No URLs found for nuclei scanning")
                results['nuclei'] = {'status': 'skipped', 'reason': 'no_urls'}
            
            logger.info("")
        
        # Step 2: Pattern matching with gf
        if self._should_run_tool('gf'):
            logger.info("[*] Step 2/3: Pattern Matching (GF)")
            
            # Get all URLs from web stage
            web_dir = Path(output_dir) / '03-web'
            all_urls_file = web_dir / 'all_urls.txt'
            
            if all_urls_file.exists() and all_urls_file.stat().st_size > 0:
                gf = Gf(self.config)
                gf_output_dir = stage_dir / 'gf_patterns'
                
                gf_results = gf.run(all_urls_file, gf_output_dir)
                results['gf'] = gf_results
            else:
                logger.warning("[!] No URLs found for pattern matching")
                results['gf'] = {'status': 'skipped', 'reason': 'no_urls'}
            
            logger.info("")
        
        # Step 3: SMB enumeration with enum4linux-ng
        if self._should_run_tool('enum4linux-ng'):
            logger.info("[*] Step 3/3: SMB Enumeration (enum4linux-ng)")
            
            # Check for hosts with port 445 (SMB) from scanning stage
            scanning_dir = Path(output_dir) / '02-scanning'
            smb_hosts = self._get_smb_hosts(scanning_dir)
            
            if smb_hosts:
                # Create temp file with SMB hosts
                smb_hosts_file = stage_dir / 'smb_hosts.txt'
                with open(smb_hosts_file, 'w') as f:
                    for host in smb_hosts:
                        f.write(f"{host}\n")
                
                enum4linux = Enum4linuxNg(self.config)
                enum4linux_output = stage_dir / 'enum4linux'
                
                enum4linux_results = enum4linux.run(smb_hosts_file, enum4linux_output)
                results['enum4linux'] = enum4linux_results
            else:
                logger.warning("[!] No SMB hosts found (port 445)")
                results['enum4linux'] = {'status': 'skipped', 'reason': 'no_smb_hosts'}
            
            logger.info("")
        
        # Compile summary
        total_vulns = 0
        critical_vulns = 0
        high_vulns = 0
        
        if 'nuclei' in results and results['nuclei'].get('status') == 'success':
            total_vulns += results['nuclei'].get('total', 0)
            critical_vulns += results['nuclei'].get('critical', 0)
            high_vulns += results['nuclei'].get('high', 0)
        
        pattern_matches = 0
        if 'gf' in results and results['gf'].get('status') == 'success':
            pattern_matches = results['gf'].get('total_matches', 0)
        
        smb_findings = 0
        if 'enum4linux' in results and results['enum4linux'].get('status') == 'success':
            smb_findings = results['enum4linux'].get('hosts_enumerated', 0)
        
        results['summary'] = {
            'total_vulnerabilities': total_vulns,
            'critical': critical_vulns,
            'high': high_vulns,
            'pattern_matches': pattern_matches,
            'smb_hosts_enumerated': smb_findings
        }
        results['stage_dir'] = str(stage_dir)
        
        logger.info("="*60)
        logger.info(f"[✓] Vulnerability Scanning Summary:")
        logger.info(f"    • Total vulnerabilities: {total_vulns}")
        logger.info(f"    • Critical: {critical_vulns}")
        logger.info(f"    • High: {high_vulns}")
        logger.info(f"    • Vulnerable patterns: {pattern_matches}")
        logger.info(f"    • SMB hosts enumerated: {smb_findings}")
        logger.info(f"    • Output directory: {stage_dir}")
        logger.info("="*60)
        
        return results
    
    def _should_run_tool(self, tool_name):
        """Check if tool should be run"""
        if self.only_tools and tool_name not in self.only_tools:
            return False
        if tool_name in self.skip_tools:
            return False
        return True
    
    def _get_smb_hosts(self, scanning_dir):
        """Extract hosts with SMB port (445) from nmap/naabu results"""
        smb_hosts = set()
        
        # Check naabu output
        naabu_file = scanning_dir / 'naabu_output.txt'
        if naabu_file.exists():
            with open(naabu_file, 'r') as f:
                for line in f:
                    if ':445' in line:
                        host = line.split(':')[0].strip()
                        smb_hosts.add(host)
        
        # Check nmap output
        nmap_file = scanning_dir / 'nmap_output.txt'
        if nmap_file.exists():
            current_host = None
            with open(nmap_file, 'r') as f:
                for line in f:
                    if 'Nmap scan report for' in line:
                        parts = line.split()
                        if len(parts) >= 5:
                            current_host = parts[4]
                    if current_host and '445/tcp' in line and 'open' in line:
                        smb_hosts.add(current_host)
        
        return list(smb_hosts)
